title: æŠ¢çº¢åŒ…æ’ä»¶åˆ†æä»¥åŠåº”ç”¨
date: 2016-01-17 16:07:44
categories:
- æŠ€æœ¯
tags:
- Android
- å…¶ä»–
---
ä¸´è¿‘æ˜¥èŠ‚ï¼Œç¾¤é‡Œçš„çº¢åŒ…åˆå¤šäº†ï¼ˆä¹Ÿè®¸ä»…ä»…æ˜¯ç¾¤å¤šäº†ï¼‰ï¼Œç”±äºæµè¡Œäº†å„ç§æŠ¢çº¢åŒ…æ’ä»¶ï¼Œçº¢åŒ…åŸºæœ¬æ˜¯ç§’æ²¡çš„èŠ‚å¥ã€‚åœ¨å¥½å¥‡å¿ƒçš„é©±ä½¿ä¸‹ç ”ç©¶äº†ä¸€ä¸‹æŠ¢çº¢åŒ…æ’ä»¶çš„åŸç†ï¼Œå‘ç°æ—¢ç®€å•åˆå¾ˆæœ‰æ„æ€ã€‚è¿˜èƒ½ç”¨æ¥å¹²äº›å…¶ä»–ç¾ç¾çš„äº‹æƒ…ğŸ˜‰ã€‚ã€‚

> å‚è€ƒGithubé¡¹ç›®æºç   [å¾®ä¿¡æŠ¢çº¢åŒ…æ’ä»¶](https://github.com/geeeeeeeeek/WeChatLuckyMoney)

## åŸºæœ¬åŸç†

åœ¨æ²¡æœ‰çœ‹Githubä¸Šçš„å®ç°çš„æ—¶å€™ï¼Œæˆ‘å¤©çœŸåœ°ä»¥ä¸ºè¿™ç§æ’ä»¶çš„åŸç†ç±»ä¼¼äºPCå¹³å°ä¸Šçš„æŒ‰é”®ç²¾çµï¼ˆAndroidç‰ˆä¹Ÿæœ‰ï¼‰ï¼Œæˆ–è€…ä¸€äº›æµ‹è¯•åŒ–å·¥å…·ã€‚è¿™ä¸€ç±»è½¯ä»¶å®ç°èµ·æ¥åº”å½“æ¯”è¾ƒå¤æ‚ï¼ŒToo Yang Too Simpleã€‚Androidå·²ç»æä¾›äº†å®Œå¤‡çš„ç³»ç»Ÿã€‚
> AccessibilityService æœåŠ¡ï¼ˆServiceï¼‰ï¼Œåˆè¡·æ˜¯ç”¨äºè¾…åŠ©æœåŠ¡ï¼Œæ€»ä¹‹å®ƒçš„**åŠŸèƒ½æ˜¯æ ¹æ®ç”¨æˆ·çš„ä¸€äº›æ“ä½œç»™ç”¨æˆ·ç›¸åº”çš„æç¤º**ï¼Œå¦‚ç»™æ®‹ç–¾äººè‡ªåŠ¨è¯»å‡ºé€‰æ‹©çš„æ–‡å­—ã€‚

æˆ‘ä»¬éœ€è¦åšçš„æ˜¯
1. ç»§æ‰¿AccessibilityServiceï¼Œå†™è‡ªå®šä¹‰çš„è¾…åŠ©æœåŠ¡
2. å½“ç”¨æˆ·Appçš„ç•Œé¢å‘é€å˜åŒ–æ—¶ï¼Œä¼šè§¦å‘Serviceçš„ç›¸å…³å›è°ƒï¼Œåœ¨è¯¥å›è°ƒä¸­å¯ä»¥è·å–**å½“å‰ç•Œé¢ä¸­çš„UIç•Œé¢å…ƒç´ èŠ‚ç‚¹**ï¼ˆä¸æ˜¯viewæœ¬èº«ï¼Œæ˜¯å®ƒçš„ä¸€ä¸ªæ˜ å°„è€Œä¸”å¯èƒ½ä¸æ˜¯ä¸€ä¸€æ˜ å°„ï¼‰ã€‚
3. æ ¹æ®**å…³é”®å­—/å…ƒç´ id**æŸ¥æ‰¾éœ€è¦çš„viewï¼Œå¤„ç†ä¹‹,å¦‚æ¨¡æ‹Ÿç‚¹å‡»ã€‚
4. done

## æºç åˆ†æ

### å­¦ä¹ AccessibilityService
å®˜æ–¹æ–‡æ¡£ä¸¤ç¯‡æ–‡ç« é€šè¯»ä¹‹ [Android Train](http://developer.android.com/intl/zh-cn/training/accessibility/service.html) && [Android APIæŒ‡å—](http://developer.android.com/intl/zh-cn/guide/topics/ui/accessibility/services.html)
ä¸­æ–‡å¯ä»¥å­¦ä¹ çš„æ–‡ç«  [Androidä¸­å¾®ä¿¡æŠ¢çº¢åŒ…æ’ä»¶åŸç†è§£æå’Œå¼€å‘å®ç°](http://blog.csdn.net/jiangwei0910410003/article/details/48895153)

### å…³é”®API
* Serviceé…ç½®

```xml
<!--è‡ªå®šä¹‰çš„æœåŠ¡å’ŒæŒ‡å®šé…ç½®æ–‡ä»¶res/xml/accessible_service_config.xml-->
<service
            android:name=".HongbaoService"
            android:permission="android.permission.BIND_ACCESSIBILITY_SERVICE">
            <intent-filter>
                <action android:name="android.accessibilityservice.AccessibilityService"/>
            </intent-filter>
            <meta-data android:name="android.accessibilityservice"
                       android:resource="@xml/accessible_service_config"/>
</service>
```

```xml
<?xml version="1.0" encoding="utf-8"?>
<accessibility-service
    xmlns:android="http://schemas.android.com/apk/res/android"
    android:description="@string/app_name"
    android:accessibilityEventTypes="typeWindowStateChanged|typeWindowContentChanged"
    android:accessibilityFeedbackType="feedbackAllMask"
    android:packageNames="com.tencent.mm"
    android:notificationTimeout="10"
    android:accessibilityFlags=""
    android:canRetrieveWindowContent="true"/>
```
> android:packageNames="com.tencent.mm" æŒ‡å®šè¦ç›‘å¬çš„ç¨‹åºçš„åŒ…å
> android:canRetrieveWindowContent="true" å¯ä»¥è·å–å…·ä½“çš„å†…å®¹
> android:accessibilityEventTypes ç›‘å¬çš„äº‹ä»¶
> android:accessibilityFeedbackType="feedbackAllMask" è®¾ç½®åé¦ˆäº‹ä»¶ï¼ˆå¦‚æŒ¯åŠ¨ä¸€ä¸‹æç¤ºç”¨æˆ·ï¼‰ï¼Œè¿™é‡Œæ˜¯å±è”½æ‰€æœ‰åé¦ˆã€‚

* Serviveå›è°ƒ

```Java
 public void onAccessibilityEvent(AccessibilityEvent event) {
 // å›è°ƒ
 }
```
* èŠ‚ç‚¹æŸ¥æ‰¾

```Java 
// è·å–æ‰€æœ‰é˜¶æ®µ
AccessibilityNodeInfo nodeInfo = event.getSource();
// æŸ¥æ‰¾æ‰€æœ‰æœ‰"é¢†å–çº¢åŒ…"çš„View
List<AccessibilityNodeInfo> node1 = nodeInfo.findAccessibilityNodeInfosByText("é¢†å–çº¢åŒ…");
// æŸ¥æ‰¾æ‰€æœ‰idæ˜¯com.tencent.mm:id/ar6
List<AccessibilityNodeInfo> node2 = nodeInfo.findAccessibilityNodeInfosByViewId("com.tencent.mm:id/ar6");
```
æ³¨ï¼šå¯ä»¥é€šè¿‡DDMSé‡Œçš„Dump View Hierarchy For UI Automator åˆ†æUIç»“æ„æ¥è·å–id

* å‡ºå‘æ“ä½œ

```Java
// å¯¹æŸä¸ªèŠ‚ç‚¹æ“ä½œ
cellNode.performAction(AccessibilityNodeInfo.ACTION_CLICK);
// æŒ‰ä¸‹æ‰‹æœºçš„åé€€é”®
performGlobalAction(GLOBAL_ACTION_BACK);
```
* å¯åŠ¨Accessibilityçš„ç³»ç»Ÿè®¾ç½®ç•Œé¢ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æ‰“å¼€æœåŠ¡

```Java
Intent intent =
            new Intent(Settings.ACTION_ACCESSIBILITY_SETTINGS);
startActivity(intent);
```

### å‡ ä¸ªæ³¨æ„ç‚¹
* AccessibilityService å»ºè®®åœ¨Android4.0ä»¥åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ä½¿ç”¨ï¼Œä¹Ÿæœ‰support_v4 å‘ä¸‹å…¼å®¹ã€‚
* Servicesé…ç½®å¯ä»¥é€šè¿‡xmlé…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä»£ç é…ç½®
* **ä¸åŒç³»ç»Ÿçš„Apiå¯èƒ½ç»“æœä¸åŒ**ï¼ˆå¦‚API16ï¼‰ï¼Œå¦‚æŸ¥æ‰¾ä¸åˆ°ä¸€äº›å…ƒç´ 

> In Android 4.1 (API Level 16) and higher, the getSource() method, as well as AccessibilityNodeInfo.getChild() and getParent(), return only view objects that are considered important for accessibility (views that draw content or respond to user actions). If your service requires all views, it can request them by setting the flags member of the service's AccessibilityServiceInfo instance to **FLAG_INCLUDE_NOT_IMPORTANT_VIEWS**

* AccessibilityNodeå¯èƒ½æœ‰ä¸€ä¸ªå®ä¾‹æ± çš„è®¾è®¡ã€‚è·å–å½“å‰çª—ä½“èŠ‚ç‚¹æ ‘çš„æ—¶å€™ï¼Œä»ä¸€ä¸ªå¯é‡ç”¨çš„å®ä¾‹æ± ä¸­è·å–ä¸€ä¸ªè¾…åŠ©èŠ‚ç‚¹ä¿¡æ¯ (AccessibilityNodeInfo)å®ä¾‹ã€‚åœ¨æ¥ä¸‹æ¥çš„è·å–æ—¶ï¼Œä»ç„¶ä»å®ä¾‹æ± ä¸­è·å–èŠ‚ç‚¹å®ä¾‹ï¼Œè¿™æ—¶å¯èƒ½ä¼šé‡ç”¨ä¹‹å‰çš„å®ä¾‹ã€‚è¿™æ ·çš„è®¾è®¡æ˜¯æœ‰å¥½å¤„çš„ï¼Œå¯ä»¥é˜²æ­¢æ¯æ¬¡è¿”å›éƒ½åˆ›å»ºå¤§é‡çš„å®ä¾‹ï¼Œå½±å“æ€§èƒ½ã€‚AccessibilityNodeProviderçš„æºç è¡¨æ˜äº†è¿™æ ·çš„è®¾è®¡ã€‚


### æŠ¢çº¢åŒ…

[å¾®ä¿¡æŠ¢çº¢åŒ…æ’ä»¶](https://github.com/geeeeeeeeek/WeChatLuckyMoney)çš„devåˆ†æ”¯çš„é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼ˆå‚è€ƒå·¥ç¨‹çš„READMEæ–‡ä»¶ï¼Œè‡´åŠ›äºåŒºåˆ†å„ç§çŠ¶æ€å’Œä¸é‡å¤æŠ¢ç›¸åŒçº¢åŒ…ï¼‰ï¼Œå®æµ‹ä¸ç¨³å®šï¼Œ**stableåˆ†æ”¯é€»è¾‘æ¯”è¾ƒç®€å•ä¹Ÿè¾ƒç¨³å®š**ã€‚å…·ä½“ä»£ç å°±ä¸è¯´äº†ã€‚

## Do Something
æŠ¢çº¢åŒ…æ’ä»¶ç½‘ä¸Šæœ‰å¾ˆå¤šå®ç°ï¼Œæˆ‘æ‰€è§çš„éƒ½æ˜¯ç”¨AccessibilityServiceæ¥åšçš„ã€‚ç”¨è¿™ä¸ªServiceçš„ç¡®å¯ä»¥åšä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼Œæ‰“ç®—åœ¨åç»­é˜¶æ®µç”¨è¿™ä¸ªåŸç†**å†™ä¸€ä¸ªå¾®ä¿¡è‡ªåŠ¨èŠå¤©ç¨‹åº**ï¼Œå½“ç„¶æ˜¯è¦å»ºç«‹åœ¨è‡ªå·±æ­å»ºçš„æ¡†æ¶ä¹‹ä¸Šçš„ã€‚


title: å¸¸è§Webæ¶æ„ä¸Dockeréƒ¨ç½²å®è·µ
date: 2016-09-20 16:00:12
categories:

- æŠ€æœ¯
- å…¨æ ˆ

tags:
- è¿ç»´
---



è¿ç»´éƒ¨ç½²çš„ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œè‡ªä¸Šè€Œä¸‹ï¼ˆä»æ¶æ„å‘ä¸‹ï¼‰çš„ä»‹ç»ä¸€äº›å¸¸è§æ¦‚å¿µã€‚æœ€åç”¨dockeréƒ¨ç½²ä¸€ä¸ªç®€å•çš„æ¶æ„ï¼Œå¯ä»¥åº”ä»˜å°ä¼ä¸šçš„å¸¸è§„éœ€æ±‚ã€‚

## åŸºæœ¬çŸ¥è¯†

### Webæ¶æ„çš„æ¼”å˜

è¿™é‡Œè¯´çš„Webæ¶æ„æ˜¯æŒ‡ç³»ç»Ÿæ¶æ„ï¼Œä¸æ¶‰åŠä»£ç å±‚é¢ã€‚

* ç¬¬é›¶é˜¶æ®µï¼šå¸¸è§çš„å¼€å‘çŠ¶æ€ï¼Œå•ç‚¹æœåŠ¡å™¨ã€æ•°æ®åº“ã€‚ç”šè‡³æœåŠ¡å™¨ä¸æ•°æ®åº“åœ¨åŒä¸€ä¸ªæœºå™¨ä¸Šï¼Œæ²¡æœ‰ä»»ä½•è´Ÿè½½å‡è¡¡ã€‚
* ç¬¬ä¸€é˜¶æ®µï¼šä¸šåŠ¡ç®€å•ï¼Œæµé‡å°ï¼Œæ²¡æœ‰ä¸“ä¸šè¿ç»´ã€‚åˆ©ç”¨Nginxæˆ–HAProxyè¿›è¡Œå•ç‚¹çš„è´Ÿè½½å‡è¡¡ï¼Œåœ¨ä¸ƒå±‚ä¹‹ä¸Šåˆ©ç”¨HTTPåè®®å°±å¯ä»¥ã€‚
* ç¬¬äºŒé˜¶æ®µï¼šä¸šåŠ¡å¤æ‚ï¼Œæµé‡å˜å¤§ï¼Œè¿™æ—¶å•ç‚¹çš„Nginxå·²ç»ä¸èƒ½æ»¡è¶³ï¼Œè¿™æ—¶ä½¿ç”¨å¼€æºLVS/å•†ç”¨è´Ÿè´£å‡è¡¡F5ï¼ˆArrayï¼‰ï¼ŒNginxæ­¤æ—¶å°±ä½œä¸ºLVSçš„èŠ‚ç‚¹æ¥ä½¿ç”¨ã€‚**å½¢æˆLVS/F5â€”> Nginx/HAProxyâ€”>AppServer**ã€‚å¯èƒ½ä¸ºäº†æ»¡è¶³ä¸åŒç½‘ç»œç¯å¢ƒä¸‹**é™æ€èµ„æº**å“åº”é€Ÿåº¦è¿˜éœ€è¦è´­ä¹°CDNæœåŠ¡ã€‚
* ç¬¬ä¸‰é˜¶æ®µï¼šè§„æ¨¡å¾ˆå¤§ï¼Œéœ€è¦**é™ä½æˆæœ¬**ï¼Œåœ¨ä¸Šè¿°æ„æ¶ä¸Šä¼˜åŒ–ï¼Œè´Ÿè´£å‡è¡¡ä½¿ç”¨è‡ªå®šä¹‰å¼€å‘çš„LVSä»£æ›¿å•†ä¸šæ–¹æ¡ˆã€‚CDNè‡ªè¡Œéƒ¨ç½²ä½¿ç”¨Nginxæˆ–è€… Squid/Varnish æ–¹æ¡ˆéƒ¨ç½²ç¼“å­˜æœåŠ¡å™¨ã€‚LVS â€” Nginx/Haproxy â€” Squid/Varnish â€” AppServerã€‚

ä¸€ä¸ªå…¸å‹ç»“æ„ï¼š

* CDNæœåŠ¡ç¼“å­˜é™æ€èµ„æºã€‚
* ç¬¬ä¸€å±‚ï¼šLVSç®¡ç†**å¤šä¸ªNginx**ï¼ŒLVSåªè´Ÿè´£**TCP/IPå±‚çš„è½¬å‘**ï¼Œå®ç°è´Ÿè½½å‡è¡¡ï¼Œä¸ä¸šåŠ¡æ— å…³ã€‚
* ç¬¬äºŒå±‚ï¼šæ¯ä¸ªNginxï¼Œä¸‹é¢éƒ½å’Œæ‰€æœ‰çš„åº”ç”¨æœåŠ¡å™¨ç›¸è¿æ¥ï¼Œå®ç°ä¸šåŠ¡ç›¸å…³çš„è´Ÿè½½å‡è¡¡ï¼ˆNginxæ˜¯httpåº”ç”¨å±‚çš„è´Ÿè½½å‡è¡¡ï¼Œå¦‚æ ¹æ®è®¿é—®ç›®å½•åŠ¨é™åˆ†ç¦»ï¼‰ã€‚åŒæ—¶ï¼ŒNginxè¿˜å¯ä»¥æä¾›é™æ€æ–‡ä»¶çš„WebæœåŠ¡å’Œéƒ¨åˆ†çš„ç¼“å­˜åŠŸèƒ½ã€‚
* ç¬¬ä¸‰å±‚ï¼šNä¸ªwebæœåŠ¡å™¨
* ç¬¬å››å±‚ï¼šwebæœåŠ¡å™¨å¯èƒ½éœ€è¦è®¿é—®æ•°æ®åº“MySQLé›†ç¾¤ï¼Œç¼“å­˜redisé›†ç¾¤ã€‚

> æ³¨æ„:
>
> 1. lvs,ngnixéƒ½æœ‰å•ç‚¹é—®é¢˜ï¼Œéœ€è¦é…åˆä½¿ç”¨keepalive
> 2. æ›´ä¸€èˆ¬æƒ…å†µï¼Œå¦‚æœç¬¬ä¸€å±‚ä¸ç”¨lvsï¼Œå•ç‹¬ç”¨ngnixä¹Ÿå¯ä»¥
> 3. lvsèƒ½åŠ›å¼ºä¸€äº›ï¼Œå¹¶å‘å‡ ç™¾ä¸‡ï¼Œnginxå¼±ä¸€äº›ï¼Œå‡ ä¸‡åˆ°å‡ å

è¿™é‡Œç¼ºä¸ªå›¾ğŸ˜€

### ç½‘ç»œåŸºç¡€æ¦‚å¿µ

* VIPï¼šè™šæ‹ŸIPåœ°å€ï¼ŒLVSä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œå³å¯¹å¤–æš´éœ²çš„IPåœ°å€ã€‚
* è™šæ‹Ÿä¸»æœºï¼šè™šæ‹Ÿä¸»æœºæ˜¯ä½¿ç”¨ç‰¹æ®Šçš„è½¯ç¡¬ä»¶æŠ€æœ¯ï¼ŒæŠŠä¸€å°çœŸå®çš„ç‰©ç†æœåŠ¡å™¨ä¸»æœºåˆ†å‰²æˆå¤šä¸ªé€»è¾‘å­˜å‚¨å•å…ƒã€‚æ¯ä¸ªé€»è¾‘å•å…ƒéƒ½æ²¡æœ‰ç‰©ç†å®ä½“ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªé€»è¾‘å•å…ƒéƒ½èƒ½åƒçœŸå®çš„ç‰©ç†ä¸»æœºä¸€æ ·åœ¨ç½‘ç»œä¸Šå·¥ä½œï¼Œå…·æœ‰å•ç‹¬çš„IPåœ°å€ï¼ˆæˆ–å…±äº«çš„IPåœ°å€ï¼‰ã€ç‹¬ç«‹çš„åŸŸåä»¥åŠå®Œæ•´çš„InternetæœåŠ¡å™¨ï¼ˆæ”¯æŒWWWã€FTPã€E-mailç­‰ï¼‰åŠŸèƒ½ã€‚è™šæ‹Ÿä¸»æœºçš„å…³é”®æŠ€æœ¯åœ¨äºï¼Œå³ä½¿åœ¨åŒä¸€å°ç¡¬ä»¶ã€åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿä¸Šï¼Œè¿è¡Œç€ä¸ºå¤šä¸ªç”¨æˆ·æ‰“å¼€çš„ä¸åŒçš„æœåŠ¡å™¨ç¨‹å¼ï¼Œä¹Ÿäº’ä¸å¹²æ‰°ã€‚è€Œå„ä¸ªç”¨æˆ·æ‹¥æœ‰è‡ªå·±çš„ä¸€éƒ¨åˆ†ç³»ç»Ÿèµ„æºï¼ˆIPåœ°å€ã€æ–‡æ¡£å­˜å‚¨ç©ºé—´ã€å†…å­˜ã€CPUç­‰ï¼‰ã€‚å„ä¸ªè™šæ‹Ÿä¸»æœºä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œåœ¨å¤–ç•Œçœ‹æ¥ï¼Œæ¯ä¸€å°è™šæ‹Ÿä¸»æœºå’Œä¸€å°å•ç‹¬çš„ä¸»æœºçš„è¡¨ç°å®Œå…¨ç›¸åŒã€‚æ‰€ä»¥è¿™ç§è¢«è™šæ‹ŸåŒ–çš„é€»è¾‘ä¸»æœºè¢«å½¢è±¡åœ°ç§°ä¸ºâ€œè™šæ‹Ÿä¸»æœºâ€ã€‚**è¿™ç§æŠ€æœ¯é€‚ç”¨äºé‚£ç§å°å‹ç½‘ç«™ï¼Œæ¯•ç«Ÿå¤§éƒ¨åˆ†ç½‘ç«™çš„æ‰€æ¶ˆè€—çš„èµ„æºè¿œè¿œå°äºä¸€å°æœºå™¨ã€‚**å‚è€ƒNginxçš„é…ç½®

### LVSåŸºç¡€çŸ¥è¯†

LVSæ¶‰åŠè¾ƒå°‘ï¼Œæš‚æ—¶ç”¨ä¸åˆ°ï¼Œå¯ä»¥å‚è€ƒ[è¿™ç¯‡æ–‡ç« ](http://liaoph.com/lvs/)ï¼Œå…¶ä¸­æœ‰äº›é”™è¯¯ã€‚

- åŸºæœ¬æ¦‚å¿µï¼šLVSæ˜¯ä¸€ä¸ªå®ç°å¯ä¼¸ç¼©ç½‘ç»œæœåŠ¡çš„Linux Virtual Serveræ¡†æ¶ã€‚è™šæ‹Ÿçš„æœåŠ¡å™¨é›†ç¾¤ç³»ç»Ÿï¼Œæä¾›è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œå·¥ä½œåœ¨å››å±‚ä¸Šï¼ˆTCP/IPå±‚ï¼‰ã€‚
- VIP

### NginxåŸºç¡€çŸ¥è¯†

#### Nginxæä¾›çš„åŠŸèƒ½

- é…ç½®è™šæ‹Ÿä¸»æœº
- web httpæœåŠ¡å™¨ï¼Œè¶…å¼ºçš„é™æ€æ–‡ä»¶æ€§èƒ½
- è´Ÿè½½å‡è¡¡
- fastcgi
- ç¼“å­˜

#### é…ç½®è¯´æ˜

é…ç½®æ–‡ä»¶ï¼š/etc/nginx/conf.d/ç›®å½•ä¸‹æ·»åŠ xxx.confæ–‡ä»¶

é…ç½®æ–‡ä»¶åˆ†ä¸ºå—å’Œè¯­å¥

- å—
  - å…¨å±€é…ç½®ï¼šé…ç½®ä¸€äº›é€šç”¨è®¾ç½®ï¼Œworker_processesæ•°ç›®ã€‚
  - serverå—ï¼šä¸€ä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¦‚æœè¦ä¸€ä¸ªnginxæœ‰å¤šä¸ªè™šæ‹Ÿä¸»æœºï¼Œå¯ä»¥é…ç½®è¿‡ä¸ªserverå—ã€‚
    - locationå—ï¼šåœ¨serverå†…ï¼Œè¡¨ç¤ºä¸€æ¡ç½‘é¡µåŒ¹é…è§„åˆ™
  - upstreamï¼šä¸€ç»„ä¸Šæ¸¸æœåŠ¡å™¨ï¼Œå³åœ¨nginxåé¢çš„webæœåŠ¡å™¨ã€‚å¯ä»¥åœ¨é‡Œé¢é…ç½®è½®è¯¢çš„ç­–ç•¥ã€‚
- è¯­å¥ï¼Œä¸€èˆ¬åœ¨å—ä¸­
  - listen ç›‘å¬ç«¯å£
  - proxy_pass ä»£ç†æŒ‡å‘çš„ä½ç½®
  - proxy_set_header è®¾ç½®httpå¤´
    - åº”ç”¨ï¼šåç«¯ipè·å–clientçœŸæ˜¯ipï¼Œå§clientçš„ipæ”¾å…¥headerä¸­ã€‚
  - root/alias åŒºåˆ†ä¸¤è€…

è™šæ‹Ÿä¸»æœºçš„[é…ç½®](http://1567045.blog.51cto.com/1557045/809972)æœ‰ä¸‰ç§æ–¹å¼ï¼š

- åŸºäºipï¼šä¸€ä¸ªç½‘å¡å¤šä¸ªçœŸå®IPï¼ˆipåˆ«åçš„æ¦‚å¿µï¼‰ï¼Œéå¸¸è´¹IP
- åŸºäºåŸŸåï¼šä¸€ä¸ªIPå¤šä¸ªåŸŸåï¼Œæ ¹æ®åŸŸåè½¬å‘ï¼Œ**ç”¨çš„æœ€å¤š**ã€‚
- åŸºäºç«¯å£ï¼šä¸€ä¸ªIPä¾æ®ä¸åŒç«¯å£åŒºåˆ†ä¸»æœºï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥ç«¯å£ï¼Œä½“éªŒä¸å¥½ã€‚

#### åŸºç¡€æ•™ç¨‹

- [ç®€æ˜æ•™ç¨‹](http://xxgblog.com/2015/05/17/nginx-start/)
- [å„ç§é…ç½®é¡¹è¯´æ˜](https://segmentfault.com/a/1190000002797601)

#### é«˜çº§æ•™ç¨‹

- [nginxè¿›ç¨‹ä¸æ¶æ„](http://tengine.taobao.org/book/chapter_02.html)

#### é…ç½®å®ä¾‹

è´Ÿè½½å‡è¡¡çš„ä¾‹å­ï¼š

```nginx
upstream backend { 
    #ip_hash; # å¯ä»¥é…ç½®è§„åˆ™
    # æ³¨æ„è¿™é‡Œçš„web1ï¼Œæ˜¯åœ¨hostä¸­å®šä¹‰çš„ï¼Œä¸ç”¨å†™http://ï¼ï¼
    server  web1:3000 max_fails=2 fail_timeout=30s;  
    server  web2:3000 max_fails=2 fail_timeout=30s;  
}

server {

  listen 80;
  # server_name example.org;
  access_log /var/log/nginx/nodejs_project.log;
  charset utf-8;

  # public folder static file
  # è¿™ç§æ–¹å¼ä¸è¡Œï¼Œå› ä¸ºå¾ˆå¤šè¯·æ±‚æ˜¯public/name.js?v=xxx
  # ä¼šæŠŠname.js?v=xxxå½“åšæ–‡ä»¶åï¼Œåº”è¯¥æœ‰å…¶ä»–åŠæ³•å¤„ç†
  # location /public {
  # alias /src/nodeclub/public/;
  # root /src/nodeclub;
  # expires 1d;
  # }

  location ~ .*\.(gif|jpg|jpeg|bmp|png|ico|txt|js|css)$ {   
   root /src/nodeclub;   
   expires 7d;
  }

  location / {
    # ä¸€ç»„æœåŠ¡å™¨ï¼Œæ³¨æ„å†™æ³•
    proxy_pass http://backend;
    # ä¸ºäº†åé¢çš„web serverèƒ½è·å–çœŸå®çš„clientIP
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }
}
```

### ç¼“å­˜åŸºç¡€çŸ¥è¯†

#### ç¼“å­˜çš„åˆ†ç±»

* æ•°æ®åº“ç¼“å­˜ï¼šæ•°æ®åº“å±‚çš„ä¸€äº›ä¸´æ—¶è¡¨æˆ–è€…ç´¢å¼•ï¼Œå‡å°‘æ•°æ®åº“è”åˆæŸ¥è¯¢ç­‰å¤æ‚æ“ä½œï¼Œç”¨ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³ã€‚ç›®çš„ï¼šæé«˜æ•°æ®åº“æ€§èƒ½ã€‚
* åº”ç”¨ç¼“å­˜ï¼ˆserverç«¯åå°åˆ†å¸ƒå¼ç¼“å­˜ï¼‰ï¼šå¯¹Webåº”ç”¨å±‚åšçš„ç¼“å­˜ï¼Œä¸€èˆ¬ä½¿ç”¨Redisä½œä¸ºå­˜å‚¨ï¼Œå¯¹ä¸šåŠ¡æ•°æ®è¿›è¡Œç¼“å­˜ï¼ˆå¦‚ç¼“å­˜Top10åˆ—è¡¨ç­‰ï¼‰ï¼Œä¸‹é¢é‡ç‚¹è¯´è¿™ä¸ªã€‚
* å‰ç«¯ç¼“å­˜ï¼ˆcdnç­‰ï¼‰ï¼šå®¢æˆ·ç«¯æµè§ˆå™¨çš„ç¼“å­˜ï¼ŒCDNé™æ€æ–‡ä»¶çš„ç¼“å­˜ç­‰å¤–éƒ¨ç¼“å­˜ï¼Œå‚è€ƒ[è¿™ç¯‡æ–‡ç« ](http://bbs.qcloud.com/thread-3775-1-1.html)ã€‚
* â€‹

#### åº”ç”¨å±‚ç¼“å­˜çš„å‡ ä¸ªé˜¶æ®µ

ç›®çš„ï¼šåº”ç”¨é€»è¾‘é¦–å…ˆä»ç¼“å­˜è·å–æ•°æ®ï¼Œå‡å°‘dbæµé‡ï¼ŒåŠ å¿«é€Ÿåº¦ï¼Œæé«˜qpsã€‚å› æ­¤ï¼Œå¯¹äºç¼“å­˜ä¸€ä¸ªé‡è¦çš„æŒ‡æ ‡æ˜¯å‘½ä¸­ç‡ã€‚ç›¸å¯¹è€Œè¨€ï¼Œå¯¹äº**ç¼“å­˜çš„æš‚æ—¶å¤±è´¥æ˜¯å¯ä»¥å®¹å¿çš„**ï¼Œåªæ˜¯å‡å°‘å‘½ä¸­ç‡ï¼Œä¸ä¼šå¼•èµ·ä¸šåŠ¡çš„å¤±è´¥ã€‚

* ç¬¬ä¸€é˜¶æ®µï¼šå•æœºï¼Œå•å®ä¾‹çš„Redisã€‚æ‰€æœ‰keyåœ¨ä¸€ä¸ªå®ä¾‹ä¸­ã€‚
* ç¬¬äºŒé˜¶æ®µï¼šåˆ†å¸ƒå¼ç¼“å­˜ï¼Œå¤šä¸ªç¼“å­˜å®ä¾‹ â€” ç¼“å­˜æŒ‰keyåšä¸€è‡´æ€§hashåˆ†å¸ƒã€‚
* ç¬¬ä¸‰é˜¶æ®µï¼šæé«˜æ¯ä¸ªå®ä¾‹çš„å¯ç”¨æ€§â€” master/slaveæ¨¡å¼å¤‡ä»½
* ç¬¬å››é˜¶æ®µï¼šæé«˜æ¯ä¸ªå®ä¾‹çš„QPS â€” å¤šçº§ç¼“å­˜ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

#### åˆ†å¸ƒå¼ç¼“å­˜ä»‹ç»

* å¤šä¸ªç¼“å­˜å®ä¾‹ï¼Œæ—¢**æŠŠä¸åŒç¼“å­˜å†…å®¹æŒ‰ç…§Keyåˆ†æ•£å­˜å‚¨åœ¨ä¸åŒçš„Rediså®ä¾‹ä¸­**ã€‚å¯ä»¥æé«˜redisçš„æ€§èƒ½å’Œå¢å¤§å¯ç”¨å†…å­˜ã€‚åŒæ—¶ï¼Œå½“æŸä¸ªå®ä¾‹æŒ‚æ‰ï¼Œä¸å½±å“å…¶ä»–ç¼“å­˜ã€‚

  * keyçš„åˆ†å¸ƒæ–¹å¼ï¼š
    * å–æ¨¡ï¼šæ·»åŠ æ–°å®ä¾‹ä¼šåŠ¨è¡
    * **ä¸€è‡´æ€§hash**ï¼ˆæ¨èï¼‰ï¼šæ·»åŠ æ–°å®ä¾‹ï¼Œå½±å“å°
  * ä¸è¶³ï¼š
    * æŸä¸ªå®ä¾‹æŒ‚äº†ï¼Œå®ƒçš„å«æœ‰çš„æ•°æ®çš„æ‰€æœ‰è¯·æ±‚éƒ½ç©¿é€åˆ°DBï¼ŒDBè´Ÿè½½å¯èƒ½çªç„¶å‡é«˜ã€‚
    * å•ä¸ªå®ä¾‹ï¼ˆæŸä¸€ä¸ªï¼‰æ‰¿å—QPSè¾¾åˆ°æé™æ€ä¹ˆåŠï¼Ÿå¯¹äºæŸäº›çƒ­é—¨æ•°æ®æœ‰è¿™ç§æƒ…å†µå‡ºç°ã€‚

* master/slaveæ¨¡å¼å¤‡ä»½ï¼šå¯¹å•ä¸ªå®ä¾‹è®¾ç«‹masterä¸slaveä¸¤ä¸ªå®ä¾‹ä¹‹é—´ç¼“å­˜æ•°æ®å¤åˆ¶ï¼Œä»masterè¯»å†™ï¼Œæ²¡æœ‰å»slaveï¼Œå†æ²¡æœ‰å»dbï¼Œç„¶ååŒæ­¥åˆ°m/sä¸­ï¼ŒæŸä¸ªæŒ‚äº†å½±å“å¾ˆå°ã€‚

  * å¼•å…¥çš„é—®é¢˜ï¼š
    * ä¸€è‡´æ€§
    * éœ€è¦2å€æœºå™¨â€”è§£å†³æ–¹æ¡ˆï¼šä¸¤å°æœºå™¨äº’ä¸ºMaster-Slaveå¤åˆ¶

  ![master-slaveæ¨¡å¼](images/redis_master_slaver.png)

* å¤šçº§ç¼“å­˜ï¼šåœ¨master/slaveæ¨¡å¼ä¸Šå†åŠ ä¸€å±‚L1Cacheã€‚å½¢æˆå¤šçº§ç¼“å­˜ï¼ŒL1Cacheæœ‰å¤šä¸ªå®ä¾‹ï¼Œå®ç°è´Ÿè½½å‡è¡¡ã€‚

  * è¿‡ç¨‹ï¼šå‰ç«¯è¯·æ±‚é¦–å…ˆä¼šéšæœºè¯·æ±‚åˆ°ä¸€ç»„L1ç¼“å­˜ï¼Œå¦‚æœè¿™ä¸ªL1ç¼“å­˜å‘½ä¸­åˆ™è¿”å›ï¼Œå¦åˆ™å†è¯·æ±‚åˆ°ä¸»ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­ï¼Œè¿”å›ï¼ŒåŒæ—¶å°†key-valueå›ç§åˆ°è¿™ä¸ªL1ç¼“å­˜ä¸­ã€‚å¦‚æœä¸»ç¼“å­˜ä¸­æ²¡æœ‰ä¸­ï¼Œåˆ™ç©¿é€åˆ°DBï¼Œè¿”å›å¹¶åŒæ—¶å›ç§åˆ°ä¸»ç¼“å­˜åŠåˆšæ‰é‚£ä¸ªL1ç¼“å­˜ã€‚L1ç¼“å­˜å¯ä»¥æœ‰å¤šç»„ï¼Œå¾ˆå¥½çš„åˆ†æ‹…äº†å¸¦å®½çš„å‹åŠ›ï¼Œå¹¶ä¸”å¯ä»¥çº¿æ€§æ‰©å±•
  * å¼•å…¥çš„é—®é¢˜ï¼šä¸€è‡´æ€§

  ![å¸¦æœ‰L1çš„å¤šçº§ç¼“å­˜](images/redis_multi_level_cache.png)

* æ•°æ®ä¸€è‡´æ€§CAPé—®é¢˜ï¼šä¸Šé¢çš„æ‰€æœ‰æƒ…å†µéƒ½ä¼šé¢ä¸´æ•°æ®ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œé’ˆå¯¹è¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªç†è®ºï¼Œæ—¢CAPä¸‹é¢ä¸‰æ¡ä¸å¯èƒ½åŒæ—¶æ»¡è¶³ï¼š

  * Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ä¹Ÿç§°ä½œåŸå­æ€§æˆ–äº‹åŠ¡æ€§ï¼Œè¡¨ç¤ºæ‰€æœ‰æ“ä½œåœ¨åŒä¸€æ—¶é—´ä¸å¯åˆ†å‰²ã€‚å¦‚å†™å…¥ç¼“å­˜å’ŒDBã€‚ å¯¹äºä¸€è‡´æ€§ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹**åªè¦è¾¾åˆ°æœ€ç»ˆä¸€è‡´æ€§**å°±å¯ä»¥äº†ã€‚
  * Avaliabilityï¼ˆå¯ç”¨æ€§ï¼‰**å¿…é¡»æ»¡è¶³**ã€‚
  * Partition toleranceï¼ˆåˆ†åŒºå®¹å¿æ€§ï¼‰ å½“æœ‰ä¸€å°æˆ–å‡ å°å®ä¾‹æŒ‚æ‰åè‡´ä½¿æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ï¼Œä¹Ÿå°±æ˜¯åˆ†åŒºå®¹å¿æ€§å¿…**é¡»å¾—åˆ°æ»¡è¶³**ã€‚

  å› æ­¤ï¼Œé’ˆå¯¹äº’è”ç½‘åº”ç”¨ï¼Œç­–ç•¥æ˜¯é¦–å…ˆå†™å…¥**ä¸»ç¼“å­˜**ï¼ˆæ—¢å†™å…¥masterä¸­ï¼ŒåŒæ—¶ä½¿L1å…¨éƒ¨å¤±æ•ˆï¼‰å’Œ**å¤„ç†é˜Ÿåˆ—**ï¼Œé˜Ÿåˆ—å†™æˆåŠŸï¼Œåç»­çš„å¤„ç†ï¼ˆæ¯”å¦‚åŒæ­¥salveï¼Œ**å†™DB**ï¼‰å°±å¯ä»¥å¼‚æ­¥æ‰§è¡Œã€‚ç¬¬ä¸€æ­¥æˆåŠŸåï¼Œæ•°æ®å¯ä»¥è¢«ç”¨æˆ·è¯»å–åˆ°ï¼Œå°±å¯ä»¥è®¤ä¸ºå†™å·²ç»å®Œæˆäº†ã€‚è‡³äºåé¢çš„å­˜å‚¨åˆ°DBåŠå®¹é”™é—®é¢˜ï¼Œå°±äº¤ç»™åé¢çš„å¼‚æ­¥å¤„ç†ç¨‹åºæå®šäº†ã€‚è¿™ç§ä¸ä¸€è‡´åªå…è®¸åœ¨å¾ˆçŸ­çš„ä¸€æ®µæ—¶é—´å†…å­˜åœ¨ï¼Œæœ€ç»ˆéœ€è¦ä¿éšœç¼“å­˜å’ŒDBè¾¾åˆ°æœ€ç»ˆçš„ä¸€è‡´ã€‚

å…¶ä»–ï¼šhttp://www.imooc.com/article/3930

### æ•°æ®åº“åŸºç¡€çŸ¥è¯†

## Docker

### dockeråŸºç¡€

* åŠŸèƒ½ï¼šæä¾›éš”ç¦»çš„ç¯å¢ƒï¼Œè½»é‡è™šæ‹Ÿæœºï¼Œæ–¹ä¾¿è¿ç»´éƒ¨ç½²
* åŸç†ï¼šå‚è€ƒè¿™ä¸€äº›åˆ—æ–‡ç« ã€‚
  * lxcï¼ˆLinux Containersï¼‰æŠ€æœ¯
    * [namespace](http://coolshell.cn/articles/17010.html)ï¼ˆç¯å¢ƒéš”ç¦»ï¼‰ï¼šç‹¬ç«‹çš„è¿›ç¨‹ç©ºé—´ï¼Œæ–‡ä»¶ç³»ç»Ÿï¼Œç½‘å¡ï¼Œæƒé™ç­‰ã€‚
    * [cgroup](http://coolshell.cn/articles/17049.html)ï¼ˆèµ„æºéš”ç¦»ï¼‰ï¼šé™åˆ¶å•ä¸ªå®¹å™¨cpuï¼Œå†…å­˜ç­‰çš„ä½¿ç”¨é‡ã€‚
  * åˆ†å±‚æ–‡ä»¶ç³»ç»Ÿï¼ˆé€‰æ‹©ä¸€ä¸ªå³å¯ï¼‰ï¼šå«æœ‰åªè¯»å±‚ï¼Œå¹¶å¯ä»¥åœ¨ä¸Šé¢æ·»åŠ å¯ä»¥å±‚ã€‚è”åˆæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å¯¹æ¯ä¸€å±‚æ–‡ä»¶ç³»ç»Ÿè®¾ç½®ä¸‰ç§æƒé™ï¼Œåªè¯»ï¼ˆreadonlyï¼‰ã€è¯»å†™ï¼ˆreadwriteï¼‰å’Œå†™å‡ºï¼ˆwhiteout-ableï¼‰ã€‚
    * [aufs](http://coolshell.cn/articles/17061.html)
    * [DeviceMapper](http://coolshell.cn/articles/17200.html)
* åº”ç”¨ï¼š
  - ç§æœ‰paasäº‘
  - å¼€å‘æµ‹è¯•ç¯å¢ƒ
  - éƒ¨ç½²webåº”ç”¨


* é‡è¦æ¦‚å¿µ
  * ä»“åº“
  * é•œåƒï¼š
    * ç‰¹ç‚¹
      * åˆ†å±‚çš„ï¼Œæ˜¯ä¸€ä¸ªå¤šå±‚ç»“æ„ï¼Œä¸€å±‚å±‚æ–‡ä»¶ç³»ç»Ÿï¼Œå«åš Union FSï¼Œè”åˆæ–‡ä»¶ç³»ç»Ÿ
      * docker é•œåƒä¸­æ¯ä¸€å±‚æ–‡ä»¶ç³»ç»Ÿ**éƒ½æ˜¯åªè¯»çš„**ã€‚
      * **æŒ‚è½½ä¹‹å**çš„ä¿®æ”¹ä¼šåœ¨æ–°çš„ä¸€ä¸ªwritableå±‚ä¸Šï¼Œæ—¢æ¯ä¸€å±‚ layer æ‰€ä¿å­˜çš„ä¿®æ”¹æ˜¯å¢é‡å¼çš„ã€‚
      * layer åœ¨é•œåƒé—´æ˜¯**å…±äº«çš„**ï¼Œä¸åŒé•œåƒé—´ï¼Œå¯¹äºæ‘˜è¦ä¸€æ ·çš„ layer åªä¼šä¿å­˜ä¸€ä»½
    * åˆ›å»ºæ–¹æ³•
      * ä¿®æ”¹å·²æœ‰é•œåƒï¼šè¿è¡ŒæŸä¸ªé•œåƒ(å¯åŠ¨å®¹å™¨)ï¼Œcommitæäº¤
      * **ä½¿ç”¨Dockerfile**ï¼ŒåŸºäºæŸä¸ªåŸºç¡€é•œåƒåˆ›å»º
    * ç»“æ„ï¼šå‚è€ƒ[è¿™ç¯‡æ–‡ç« ](http://blog.csdn.net/jcjc918/article/details/46500031)
  * å®¹å™¨ï¼šè¿è¡Œçš„é•œåƒ
  * æ•°æ®å·volumeï¼šå®¹å™¨å¤–éƒ¨çš„å¯ä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ä½¿ç”¨çš„ç‰¹æ®Šç›®å½•ï¼Œ**ä¸€èˆ¬ç”¨æ¥æ”¾æ•°æ®åº“ï¼Œæ—¥å¿—ï¼Œè¿™äº›æŒä¹…åŒ–çš„å­˜å‚¨**ã€‚
    * æ•°æ®å·å¯ä»¥åœ¨å®¹å™¨ä¹‹é—´å…±äº«å’Œé‡ç”¨
    * **å¯¹æ•°æ®å·çš„ä¿®æ”¹ä¼šç«‹é©¬ç”Ÿæ•ˆ**
    * **å¯¹æ•°æ®å·çš„æ›´æ–°ï¼Œä¸ä¼šå½±å“é•œåƒ**
    * æ•°æ®å·é»˜è®¤ä¼šä¸€ç›´å­˜åœ¨ï¼Œå³ä½¿å®¹å™¨è¢«åˆ é™¤
  * dockerä¸­çš„initè¿›ç¨‹ï¼šä¸linuxçš„initè¿›ç¨‹ä¸åŒï¼Œ[å‚è€ƒæ–‡ç« ](https://yq.aliyun.com/articles/5545)
    * é¼“åŠ±ï¼šä¸€ä¸ªå®¹å™¨ä¸€ä¸ªè¿›ç¨‹(one process per container)ã€‚éå¸¸é€‚åˆä»¥å•è¿›ç¨‹ä¸ºä¸»çš„å¾®æœåŠ¡æ¶æ„çš„åº”ç”¨ã€‚
    * ä¸€ä¸ªå®¹å™¨ä¹Ÿå¯ä»¥è¿è¡Œå¤šä¸ªè¿›ç¨‹
    * æ¯ä¸ªContaineréƒ½æ˜¯**Docker Daemonçš„å­è¿›ç¨‹**ï¼Œæ¯ä¸ªContainerè¿›ç¨‹ç¼ºçœéƒ½å…·æœ‰ä¸åŒçš„PIDåç©ºé—´ã€‚
    * å½“åˆ›å»ºä¸€ä¸ªDockerå®¹å™¨çš„æ—¶å€™ï¼Œå°±ä¼šæ–°å»ºä¸€ä¸ªPIDåç©ºé—´ã€‚å®¹å™¨å¯åŠ¨è¿›ç¨‹åœ¨è¯¥åç©ºé—´å†…PIDä¸º1ã€‚**å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå’Œå…¶PID1è¿›ç¨‹ä¸€è‡´**
    * `docker exec`å‘½ä»¤å¯ä»¥è¿›å…¥æŒ‡å®šçš„å®¹å™¨å†…éƒ¨æ‰§è¡Œå‘½ä»¤ã€‚ç”±å®ƒå¯åŠ¨çš„è¿›ç¨‹å±äºå®¹å™¨çš„namespaceå’Œç›¸åº”çš„cgroupã€‚ä½†æ˜¯**è¿™äº›è¿›ç¨‹çš„çˆ¶è¿›ç¨‹æ˜¯Docker Daemon**è€Œéå®¹å™¨çš„PID1è¿›ç¨‹ã€‚
    * PID1è¿›ç¨‹å¯¹äºæ“ä½œç³»ç»Ÿè€Œè¨€å…·æœ‰ç‰¹æ®Šæ„ä¹‰ã€‚æ“ä½œç³»ç»Ÿçš„PID1è¿›ç¨‹æ˜¯initè¿›ç¨‹ï¼Œä»¥å®ˆæŠ¤è¿›ç¨‹æ–¹å¼è¿è¡Œï¼Œæ˜¯æ‰€æœ‰å…¶ä»–è¿›ç¨‹çš„ç¥–å…ˆï¼Œå…·æœ‰å®Œæ•´çš„è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†èƒ½åŠ›ã€‚åœ¨Dockerå®¹å™¨ä¸­ï¼ŒPID1è¿›ç¨‹æ˜¯å¯åŠ¨è¿›ç¨‹ï¼Œå®ƒä¹Ÿä¼šè´Ÿè´£å®¹å™¨å†…éƒ¨è¿›ç¨‹ç®¡ç†çš„å·¥ä½œã€‚è€Œè¿™ä¹Ÿå°†å¯¼è‡´è¿›ç¨‹ç®¡ç†åœ¨Dockerå®¹å™¨å†…éƒ¨å’Œå®Œæ•´æ“ä½œç³»ç»Ÿä¸Šçš„ä¸åŒã€‚
    * åˆ©ç”¨**Supervisorç­‰å·¥å…·ä½œä¸ºPID1è¿›ç¨‹**æ˜¯åœ¨å®¹å™¨ä¸­æ”¯æŒå¤šè¿›ç¨‹ç®¡ç†çš„ä¸»è¦å®ç°æ–¹å¼
  * dockerä¸­çš„ç½‘ç»œ
    * Docker å¯åŠ¨æ—¶
      * ä¼šåœ¨ä¸»æœºä¸Šåˆ›å»ºä¸€ä¸ªÂ `docker0`Â è™šæ‹Ÿç½‘æ¡¥ï¼Œå®é™…ä¸Šæ˜¯ Linux çš„ä¸€ä¸ª bridgeï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè½¯ä»¶äº¤æ¢æœºã€‚
      * Docker éšæœºåˆ†é…ä¸€ä¸ªæœ¬åœ°æœªå ç”¨çš„ç§æœ‰ç½‘æ®µç»™Â `docker0`ã€‚æ¯”å¦‚å…¸å‹çš„Â `172.17.42.1`ï¼Œæ©ç ä¸ºÂ `255.255.0.0`ã€‚

    * åˆ›å»ºä¸€ä¸ª Docker å®¹å™¨
      * åˆ›å»ºäº†ä¸€å¯¹Â `veth pair`Â æ¥å£ï¼ˆå½“æ•°æ®åŒ…å‘é€åˆ°ä¸€ä¸ªæ¥å£æ—¶ï¼Œå¦å¤–ä¸€ä¸ªæ¥å£ä¹Ÿå¯ä»¥æ”¶åˆ°ç›¸åŒçš„æ•°æ®åŒ…ï¼‰
      * è¿™å¯¹æ¥å£ä¸€ç«¯åœ¨å®¹å™¨å†…ï¼Œå³Â `eth0`
      * å¦ä¸€ç«¯åœ¨æœ¬åœ°å¹¶è¢«æŒ‚è½½åˆ°`docker0`Â ç½‘æ¡¥ï¼Œåç§°ä»¥Â `veth`Â å¼€å¤´ï¼ˆä¾‹å¦‚Â `vethAQI2QT`ï¼‰

    * ç‰¹ç‚¹ï¼š**ä¸€ä¸ªç§æœ‰çš„ç½‘ç»œï¼Œé€šè¿‡ nat è¿æ¥å¤–ç½‘ï¼Œå¦‚æœè¦è®©å¤–ç½‘è¿æ¥åˆ°å®¹å™¨ä¸­ï¼Œå°±éœ€è¦åšç«¯å£æ˜ å°„ã€‚**

    * ç»“æ„å›¾

      ![](https://yeasy.gitbooks.io/docker_practice/content/_images/network.png)
* åŸºæœ¬æ“ä½œï¼šå¯ä»¥å‚è€ƒ[è¿™ä¸ªæŒ‡å—](https://www.gitbook.com/book/yeasy/docker_practice)
  * **æŸ¥çœ‹æ‰€æœ‰é•œåƒ**ï¼š`docker images`
  * **æŸ¥çœ‹æ‰€æœ‰å®¹å™¨**ï¼ˆè¿è¡Œçš„ï¼Œåœæ­¢çš„ï¼‰ï¼š`docker ps`
  * åˆ›å»ºé•œåƒï¼š `docker build . `ä½¿ç”¨**å½“å‰ç›®å½•**ä¸‹çš„Dockerfileæ–‡ä»¶åˆ›å»ºï¼Œå¯é€‰å‚æ•° -t åŠ tagã€‚
  * **è¿è¡Œå®¹å™¨**ï¼š`docker run -p 80:80 -d [image ID or NAMES] `
    * `-d` åå°è¿è¡Œ
    * `-p hostPort:containerPort` **æ˜ å°„ç«¯å£**ï¼ŒæŒ‡å®šæ˜ å°„åˆ°ä¸»æœºæŸä¸ªå…·ä½“çš„ipä¹Ÿå¯ä»¥ï¼š`ip:hostPort:containerPort`ï¼Œå¯ä»¥ç”¨å¤šä¸ª-pæ¥ç»‘å®šå¤šæ¬¡ã€‚
    * `-v /local_dir:/containr_dir` æŒ‡å®šæŒ‚è½½çš„æ•°æ®å·ï¼Œå¯ä»¥æŒ‚è½½å¤šä¸ªï¼ŒæŒ‡å®šæƒé™
    * â€”name æŒ‡å®šä¸€ä¸ªåå­—
    * `-t -i`Â é€‰é¡¹è®©Dockeråˆ†é…ä¸€ä¸ªä¼ªç»ˆç«¯ï¼ˆpseudo-ttyï¼‰å¹¶ç»‘å®šåˆ°å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¸Šï¼ŒÂ `-i`Â åˆ™è®©å®¹å™¨çš„æ ‡å‡†è¾“å…¥ä¿æŒæ‰“å¼€ã€‚æ•ˆæœæ˜¯æ‰“å¼€ç»ˆç«¯ã€‚
      * --name xxxx ä¸ºå®¹å™¨è‡ªå®šä¹‰å‘½å
    * CMD åé¢å¯ä»¥æ¥ä¸€ä¸ªå¯åŠ¨è¿è¡Œçš„å‘½ä»¤
  * åˆ é™¤é•œåƒï¼š`docker rmi [image ID or NAMES]`
  * **åˆ é™¤å®¹å™¨**ï¼š`docker rm [container ID or NAMES]`
  * **ç™»å½•å®¹å™¨**ï¼š`docker exec -i -t b0c5c63c4630 bash`
  * æŸ¥çœ‹å®¹å™¨è¾“å‡º `docker logs [container ID or NAMES]`
  * æŸ¥çœ‹æ‰€æœ‰å˜é‡ `docker inspect`
  * æ•°æ®å·å®¹å™¨ï¼šå…¶å®å°±æ˜¯ä¸€ä¸ªæ­£å¸¸çš„å®¹å™¨ï¼Œä¸“é—¨ç”¨æ¥æä¾›æ•°æ®å·ä¾›å…¶å®ƒå®¹å™¨æŒ‚è½½çš„ã€‚
    * Â `docker run -d --volumes-from [image ID or NAMES]`Â æ¥æŒ‚è½½ dbdata å®¹å™¨ä¸­çš„æ•°æ®å·ã€‚
    * Â æ‰€æŒ‚è½½æ•°æ®å·çš„å®¹å™¨è‡ªå·±å¹¶ä¸éœ€è¦ä¿æŒåœ¨è¿è¡ŒçŠ¶æ€
  * å®¹å™¨äº’è”:Â å¯ä»¥è®©å®¹å™¨ä¹‹é—´å®‰å…¨çš„è¿›è¡Œäº¤äº’ã€‚`--link name:alias`ï¼Œå…¶ä¸­Â `name`Â æ˜¯è¦é“¾æ¥çš„å®¹å™¨çš„åç§°ï¼Œ`alias`Â æ˜¯è¿™ä¸ªè¿æ¥çš„åˆ«åã€‚**ä¼šå†™å…¥åˆ°å®¹å™¨çš„hostä¸­ï¼Œä½¿ç”¨å®ƒå¯ä»¥è®¿é—®åˆ°è¢«è¿æ¥çš„å®¹å™¨ã€‚**
    *  docker run -d  --link db:db [image ID or NAMES]
* ç½‘ç»œé…ç½®ä¸ç®¡ç†
  * å®¹å™¨æœ‰è‡ªå·±çš„å†…éƒ¨ç½‘ç»œå’Œ ip åœ°å€
  * [å¦‚ä½•å¤šå°ä¸»æœºçš„å®¹å™¨äº’è”ï¼Ÿ](https://yeasy.gitbooks.io/docker_practice/content/cases/container_connect.html)

> **åŒºåˆ†é•œåƒä¸å®¹å™¨**ï¼šå®¹å™¨æ˜¯é•œåƒçš„å®ä¾‹

### dockeréƒ¨ç½²å®è·µ

* Dockerfileç¼–å†™ï¼šDockerfileåŒ…å«æ„å»ºé•œåƒæ‰€éœ€çš„ä¿¡æ¯
  * åŸºç¡€é•œåƒä¿¡æ¯ï¼šç¬¬ä¸€è¡Œ`FROM xxx` åŸºç¡€é•œåƒ
  * ç»´æŠ¤è€…ä¿¡æ¯ `MAINTAINER: docker_user <docker_user at email.com>`
  * `ADD <src> <dest>`å‘½ä»¤ï¼Œå¤åˆ¶å¤åˆ¶æŒ‡å®šçš„Â `src`Â åˆ°å®¹å™¨ä¸­çš„Â `dest`
  * é•œåƒæ“ä½œæŒ‡ä»¤`RUN  command`ï¼Œæ¯ä¸€ä¸ªç›¸å½“äºcommitä¸€æ¬¡
  * **å®¹å™¨å¯åŠ¨æ—¶æ‰§è¡ŒæŒ‡ä»¤**: `CMD command`
  * CMDä¸ENTRYPOINT https://segmentfault.com/q/1010000000417103

* docker-composeçš„ä½¿ç”¨

  * ä»€ä¹ˆæ˜¯ï¼šå¯ä»¥æ–¹ä¾¿çš„**ç”Ÿæˆå¤šä¸ªé•œåƒ**å’Œ**å¯åŠ¨å¤šä¸ªdockerå®¹å™¨**ï¼Œå¹¶ä¸”**ç»„ç»‡ï¼ˆcomposeï¼‰ä»–ä»¬çš„å…³ç³»**
  * æ¦‚å¿µ
    * æœåŠ¡ï¼ˆserviceï¼‰ï¼šä¸€ä¸ªåº”ç”¨å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥è¿è¡Œå¤šä¸ªç›¸åŒé•œåƒçš„å®ä¾‹ã€‚
    * é¡¹ç›®(project)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒã€‚
    * ä¸€ä¸ªé¡¹ç›®å¯ä»¥ç”±å¤šä¸ªæœåŠ¡ï¼ˆå®¹å™¨ï¼‰å…³è”è€Œæˆï¼ŒCompose é¢å‘é¡¹ç›®è¿›è¡Œç®¡ç†ã€‚
  * docker-composeå‘½ä»¤
    - docker-compose build . ç¼–è¯‘æ‰€æœ‰çš„é•œåƒ
    - docker-compose up è¿è¡Œæ‰€æœ‰çš„å®¹å™¨ï¼ˆåŒ…å«ç¼–è¯‘


*   å®è·µï¼š
    * docker-compose.yml æ–‡ä»¶

    ```yaml
     web1: # ç¬¬ä¸€ä¸ªwebå®¹å™¨
        build: nodeclub/. # ç¼–è¯‘è¯¥ç›®å½•ä¸‹çš„dockeré•œåƒ
        volumes: # æŒ‚è½½æ•°æ®å·ï¼Œé‡Œé¢æ˜¯è¿è¡Œçš„ç¨‹åºæºç 
          - "./nodeclub:/src/nodeclub"
        ports: # æŒ‡å®šè‡ªèº«çš„æš´éœ²ç«¯å£
          - "3000"
        links: # å®¹å™¨äº’è”
          - "redis:redis" # redis
          - "db:db" #æ•°æ®åº“
        command: nodemon -L nodeclub/app.js # æ‰§è¡Œçš„å¯åŠ¨å‘½ä»¤

    web2: # ç¬¬äºŒä¸ªwebå®¹å™¨
        build: nodeclub/. # ç¼–è¯‘è¯¥ç›®å½•ä¸‹çš„dockeré•œåƒ
        volumes:
          - "./nodeclub:/src/nodeclub"
        ports: 
          - "3000"
        links:
          - "redis:redis"
          - "db:db"
        command: nodemon -L nodeclub/app.js
        
    nginx:
        restart: always
        build: nginx/.
        ports:
          - "80:80"  # ç«¯å£æ˜ å°„
        volumes_from: # æŒ‚è½½çš„æ•°æ®å®¹å™¨
          - web1
        links:
          - web1:web1 # å®¹å™¨äº’è”
          - web2:web2

    redis:
        image: redis # ç›´æ¥ä½¿ç”¨è¿™ä¸ªåå­—çš„dockeré•œåƒ

    db:
        image: mongo:3.0.5
        volumes: # æ•°æ®åº“æŒ‚è½½çš„å¤–éƒ¨æŒä¹…åŒ–ç›®å½•
          - "./data/db:/data/db"
    ```

*   webå®¹å™¨Dockerfileæ–‡ä»¶ï¼šç”Ÿæˆé•œåƒ

    ```dockerfile
      FROM node

      RUN mkdir /src

      # å®‰è£…ä¸€äº›å·¥å…·
      # RUN npm install express-generator -g
      RUN npm install nodemon -g

      # æ‹·è´package.json,å®‰è£…ä¾èµ–æ¨¡å—
      WORKDIR /src
      ADD package.json package.json
      RUN npm install --registry=https://registry.npm.taobao.org

      # ç«¯å£
      EXPOSE 3000

      # CMD node app.js
    ```

*   ngnixå®¹å™¨çš„Dockerfileæ–‡ä»¶ï¼šæ‹·è´é…ç½®æ–‡ä»¶ï¼ˆå‚è€ƒä¸Šæ–‡ï¼‰ï¼Œç”Ÿæˆnginxé•œåƒ

    ```dockerfile
      FROM nginx
      # åˆ é™¤é»˜è®¤çš„é…ç½®
      RUN rm /etc/nginx/conf.d/default.conf
      # æ‹·è´æ–°é…ç½®
      ADD nodejs.conf /etc/nginx/conf.d/nodejs.conf
    ```

*   æœ¬åœ°æ–°å»º`data`ç›®å½•ä½œä¸ºvolumeç›®å½•ï¼ŒæŒä¹…åŒ–å­˜å‚¨æ•°æ®ï¼Œä¿æŒæ•°æ®åº“.


### å­¦ä¹ æ–‡ç« 

* [dockerçš„nodeéƒ¨ç½²å®ä¾‹](http://dockone.io/article/291)
* [docker-composeä¸€æ­¥æ­¥éƒ¨ç½²nodeå®ä¾‹é¡¹ç›®](https://github.com/b00giZm/docker-compose-nodejs-examples)
* [dockerä¸­çš„å¤šè¿›ç¨‹ä¸init]( https://yq.aliyun.com/articles/5545)
* [docker practice gitbook](https://www.gitbook.com/book/yeasy/docker_practice/details)
* [ç†è§£ç½‘æ¡¥](http://blog.chinaunix.net/uid-18824385-id-107165.html)

## é—ç•™é—®é¢˜

* dockeråœ¨ç”Ÿäº§ç¯å¢ƒçš„ä½¿ç”¨ï¼Œé›†ç¾¤ä¸ç›‘æ§ docker swarm



##